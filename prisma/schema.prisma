// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  role          String    @default("EMPLOYEE") // DIRECTOR, MANAGER, TEAM_LEADER, EMPLOYEE, INTERN
  department    String? // Optional department/team assignment
  managerId     String? // Reports to (for hierarchy)
  manager       User?     @relation("ManagerToEmployees", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates  User[]    @relation("ManagerToEmployees")
  projects      Project[] @relation("ProjectManager")
  managedSpaces Space[]   @relation("SpaceManager")

  // Compliance
  flagCount     Int       @default(0)
  lastFlaggedAt DateTime?

  tasks         Task[]         @relation("AssignedTo")
  milestones    Milestone[]    @relation("MilestoneOwner")
  dailyReports  DailyReport[]  @relation("UserDailyReports")
  weeklyReports WeeklyReport[] @relation("UserWeeklyReports")
  expenses      Expense[]      @relation("UserExpenses")
  accounts      Account[]
  sessions      Session[]
  notifications Notification[] @relation("UserNotifications")
  activities    Activity[]
  comments      Comment[]

  // Issue Tracking
  reportedIssues Issue[] @relation("IssueReporter")
  assignedIssues Issue[] @relation("IssueAssignee")
  resolvedIssues Issue[] @relation("IssueResolver")

  // Meetings
  organizedMeetings Meeting[] @relation("OrganizedMeetings")
  meetingAttendance Meeting[] @relation("MeetingAttendees")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ... existing models ...

model Issue {
  id            String   @id @default(uuid())
  title         String
  description   String?
  projectId     String?
  project       Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  spaceId       String?
  space         Space?   @relation(fields: [spaceId], references: [id])
  severity      String // CRITICAL, HIGH, MEDIUM, LOW
  status        String   @default("OPEN") // OPEN, RESOLVING, CLOSED, RESOLVED
  
  reporterId    String?
  reporter      User?    @relation("IssueReporter", fields: [reporterId], references: [id])
  
  assignedToId  String?
  assignedTo    User?    @relation("IssueAssignee", fields: [assignedToId], references: [id])

  resolvedById  String?
  resolvedBy    User?    @relation("IssueResolver", fields: [resolvedById], references: [id])
  
  resolution    String? // Remarks/Solution
  resolutionDate DateTime?

  owner         String? // Keeping for backward compatibility (display name)
  
  daysOpen      Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Meeting {
  id          String   @id @default(uuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  meetingLink String? // Zoom/Google Meet link

  organizerId String
  organizer   User   @relation("OrganizedMeetings", fields: [organizerId], references: [id])

  attendees User[] @relation("MeetingAttendees")

  googleEventId String? // For checking sync status

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String   @default("INFO") // INFO, SUCCESS, WARNING, ERROR
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Space {
  id          String      @id @default(uuid())
  name        String
  description String?
  color       String      @default("#0052CC")
  type        String      @default("STANDARD") // STANDARD, DEPARTMENT, ARCHIVE
  projects    Project[]
  resources   Resource[]  @relation("SpaceResources")
  wikiPages   WikiPage[]
  documents   Document[]
  issues      Issue[]
  milestones  Milestone[]
  managerId   String?
  manager     User?       @relation("SpaceManager", fields: [managerId], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  budget      Decimal  @default(0)
  status      String   @default("INITIATION") // INITIATION, PLANNING, EXECUTION, MONITORING, CLOSED
  managerId    String?
  manager      User?         @relation("ProjectManager", fields: [managerId], references: [id])
  tasks        Task[]
  reports      Report[]
  resources    Resource[]    @relation("ProjectResources")
  expenses     Expense[]
  documents    Document[]
  wikiPages    WikiPage[]
  issues       Issue[]
  milestones   Milestone[]
  dailyReports DailyReport[]
  activities   Activity[]
  comments     Comment[]
  meetings     Meeting[]
  spaceId      String?
  space        Space?        @relation(fields: [spaceId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Expense {
  id          String   @id @default(uuid())
  amount      Decimal
  category    String // TRAVEL, HARDWARE, SOFTWARE, SERVICES
  description String?
  date        DateTime @default(now())
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  userId      String
  user        User     @relation("UserExpenses", fields: [userId], references: [id])
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Task {
  id          String    @id @default(uuid())
  title       String
  description String?
  deadline    DateTime
  status      String    @default("TODO") // TODO, IN_PROGRESS, REVIEW, DONE
  priority    Int       @default(1) // 1: Low, 2: Medium, 3: High
  projectId   String?
  assignedTo  User?     @relation("AssignedTo", fields: [userId], references: [id])
  userId      String?
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category    String? // EUSAI_AGREEMENT, SPORTS_LOGO, MOU, BUSINESS_ORDER, CUSTOM
  comments    Comment[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Resource {
  id          String    @id @default(uuid())
  name        String
  type        String // PERSONNEL, TOOL, MATERIAL, COMPUTE
  role        String?
  status      String    @default("AVAILABLE") // AVAILABLE, ALLOCATED, OFFLINE
  hourlyRate  Decimal
  utilization Int       @default(0)
  projects    Project[] @relation("ProjectResources")
  spaceId     String?
  space       Space?    @relation("SpaceResources", fields: [spaceId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Report {
  id          String   @id @default(uuid())
  type        String // FINANCIAL, RESOURCE, RISK
  content     String
  generatedAt DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
}

model Webhook {
  id        String   @id @default(uuid())
  url       String
  event     String // PROJECT_CREATED, PROJECT_UPDATED, TASK_COMPLETED
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model Document {
  id         String   @id @default(uuid())
  name       String
  type       String // PDF, DOCX, IMAGE, etc.
  size       String
  url        String
  projectId  String?
  project    Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  spaceId    String?
  space      Space?   @relation(fields: [spaceId], references: [id])
  uploadedBy String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model WikiPage {
  id        String   @id @default(uuid())
  title     String
  content   String
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  spaceId   String?
  space     Space?   @relation(fields: [spaceId], references: [id])
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}



model University {
  id            String  @id @default(uuid())
  name          String
  location      String?
  status        String  @default("PROSPECT") // PROSPECT, PARTNER, INACTIVE
  contactPerson String?
  email         String?
  phone         String?
  website       String?

  milestones     Milestone[]
  businessOrders BusinessOrder[]

  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BusinessOrder {
  id       String   @id @default(uuid())
  title    String
  amount   Decimal
  currency String   @default("INR")
  date     DateTime @default(now())
  status   String   @default("PENDING") // PENDING, PAID, CANCELLED

  milestoneId String?
  milestone   Milestone? @relation(fields: [milestoneId], references: [id])

  universityId String
  university   University @relation(fields: [universityId], references: [id])

  universityName String? // Cached university name for quick access
  orderType      String? // School Spirit, Outgoing Packages, Merchandise Jersey

  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Milestone {
  id            String    @id @default(uuid())
  title         String
  description   String?
  category      String // EUSAI_AGREEMENT, SPORTS_LOGO, MOU, BUSINESS_ORDER, CUSTOM
  mouType       String? // Merchandise Store, School Spirit, FGSN Studio, etc.
  targetDate    DateTime
  completedDate DateTime?
  progress      Int       @default(0) // 0-100%
  status        String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, DELAYED

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  universityId String?
  university   University? @relation(fields: [universityId], references: [id])

  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id])
  businessOrders BusinessOrder[]

  priority  String @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  owner     String // UserId assigned to this
  ownerUser User   @relation("MilestoneOwner", fields: [owner], references: [id])

  isFlagged Boolean   @default(false)
  remarks   String? // For flagging or quick notes
  comments  Comment[]

  metadata  String? // Flexible field for category-specific data
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DailyReport {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation("UserDailyReports", fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime @default(now())
  tasksCompleted  Int      @default(0)
  hoursWorked     Float    @default(0)
  accomplishments String
  challenges      String?
  tomorrowPlan    String?
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  submittedAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, date])
}

model WeeklyReport {
  id                  String   @id @default(uuid())
  userId              String
  user                User     @relation("UserWeeklyReports", fields: [userId], references: [id], onDelete: Cascade)
  weekStartDate       DateTime
  weekEndDate         DateTime
  totalTasksCompleted Int      @default(0)
  totalHoursWorked    Float    @default(0)
  keyAccomplishments  String
  kpiMetrics          String? // Flexible KPI storage
  nextWeekGoals       String?
  managerNotes        String?
  performanceScore    Int? // 1-100
  generatedAt         DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, weekStartDate])
}

model Activity {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  metadata  String?
  timestamp DateTime @default(now())

  @@index([projectId])
  @@index([userId])
}

model Comment {
  id          String     @id @default(uuid())
  projectId   String?
  project     Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskId      String?
  task        Task?      @relation(fields: [taskId], references: [id], onDelete: SetNull)
  milestoneId String?
  milestone   Milestone? @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  userId      String
  user        User       @relation(fields: [userId], references: [id])
  text        String
  attachments Json? // Stored as array of strings
  timestamp   DateTime   @default(now())

  @@index([projectId])
  @@index([taskId])
  @@index([milestoneId])
  @@index([userId])
}
